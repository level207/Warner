C51 COMPILER V9.00   MAIN                                                                  03/31/2013 17:28:43 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\Program Files\Keil C\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /**************************头文件、宏定义、函数声明*************************/
   2          
   3          #include <reg52.h>
   4          #include <intrins.h>
   5          #include <stdio.h>
   6          #include <string.h>
   7          
   8          #define uint unsigned int
   9          #define uchar unsigned char
  10          #define MAXCHAR 81
  11          
  12          void delay(uchar ms);
  13          void Ini_UART(void);
  14          void ser();
  15          void clearBuff(void);
  16          void Print_Char(uchar ch);
  17          void Print_Str(uchar *str);
  18          void led(int i);
  19          
  20          void AT(void);
  21          bit lcd_bz(void);
  22          void lcd_wcmd(uchar cmd);
  23          void lcd_disp_char(uchar x,uchar y,uchar dat);
  24          void lcd_disp_str(uchar column,uchar line,uchar *str);
  25          void lcd_wdat(uchar dat);
  26          void lcd_init(void);
  27          uchar get_mq9(void);
  28          
  29          /*********************************定义数组**********************************/
  30          
  31          uchar  aa[MAXCHAR];
  32          
  33          code uchar ATE0[]="ATE0\r\n";                      //程序初始化AT部分首先关闭回显
  34          code uchar CREG_CMD[]="AT+CREG?\r\n";      //查询网络注册情况
  35          code uchar SMS_send[]="AT+CMGS=18\r\n";    //八位位组代码数目
  36          code uchar ATCN[]="AT+CNMI=2,1\r\n";       //短信存入SIM卡
  37          code uchar CMGF[]="AT+CMGF=0\r\n";                 //消息格式为PDU,中文短信
  38          code uchar CMGR[12]="AT+CMGR=1\r\n";       //读取第一条消息
  39          code uchar CMGD[12]="AT+CMGD=1\r\n";       //删除第一条消息
  40          /*****************************************************************************
  41          1.如果你的晶振是11.0592M
  42          只需要修改下面的号码就可以了,给成你手上拿着的手机的号码
  43          
  44          
  45          修改方法   在下面这段字符中找到 5129021411F5 
  46           
  47           其实5129021411F5 --> 15922041115
  48          18622044083 8126924480F3
  49          
  50          
  51           看明白了吗  电话是两位两位颠倒 将您手上的手机号码替换即可
  52          *****************************************************************************/
  53          uchar  code Sms2_Pdu[]="0891683108200205F011000B818126924480F30008A704521B601D";
  54          
  55          /*********************************端口定义**********************************/
C51 COMPILER V9.00   MAIN                                                                  03/31/2013 17:28:43 PAGE 2   

  56          
  57          sbit d0 = P2^4;//mq9输入端口
  58          sbit rs = P2^5;
  59          sbit rw = P2^6;
  60          sbit ep = P2^7;
  61          
  62          /*****************************************************************************
  63          函数名称：delay
  64          函数功能: LCD延时子程序
  65          入口参数: ms
  66          出口参数: 无
  67          *****************************************************************************/
  68          
  69          void delay(uchar ms)
  70          {
  71   1              unsigned char i;
  72   1      
  73   1              while(ms--)
  74   1              {
  75   2                      for(i = 0; i< 250; i++)
  76   2                      {
  77   3                              _nop_();
  78   3                              _nop_();
  79   3                              _nop_();
  80   3                              _nop_();
  81   3      
  82   3                      }
  83   2              }
  84   1      }
  85          
  86          /*****************************************************************************
  87          函数名称：Ini_UART
  88          函数功能：串口初始化、定时器初始化
  89          入口参数: 无     
  90          出口参数：无
  91          *****************************************************************************/
  92          
  93          void Ini_UART(void)//串口初始化、定时器初始化
  94          {
  95   1          SCON = 0x50 ;  //SCON: serail mode 1, 8-bit UART, enable ucvr
  96   1          //UART为模式1，8位数据，允许接收
  97   1          TMOD |= 0x20 ; //TMOD: timer 1, mode 2, 8-bit reload
  98   1          //定时器1为模式2,8位自动重装
  99   1          PCON |= 0x80 ; //SMOD=1;
 100   1          TH1 = 0xFA ;   //Baud:19200 fosc="11".0592MHz
 101   1          TL1=0xFA;
 102   1          IE |= 0x90 ;     //Enable Serial Interrupt
 103   1          TR1 = 1 ;       // timer 1 run
 104   1          TI=1;
 105   1          ES=1;
 106   1      }
 107          
 108          /*****************************************************************************
 109          函数名称：ser() interrupt 4
 110          函数功能：串口中断函数，串口有数据传输时进入此中断
 111          入口参数: 无     
 112          出口参数：无
 113          *****************************************************************************/
 114          
 115          void ser() interrupt 4
 116          {
 117   1              uchar j=0;
C51 COMPILER V9.00   MAIN                                                                  03/31/2013 17:28:43 PAGE 3   

 118   1      
 119   1          if(RI==1)
 120   1          {  
 121   2                      aa[j]=SBUF;//命令存到命令数组
 122   2                      RI=0; //软件清除接收中断
 123   2              j++;
 124   2      
 125   2          }
 126   1      }
 127          
 128          /*****************************************************************************
 129          函数名称：clearBuff
 130          函数功能: 清楚串口缓冲区数据
 131          入口参数: 无
 132          出口参数: 无
 133          *****************************************************************************/
 134          
 135          void clearBuff(void)
 136          {
 137   1              uchar j;
 138   1      
 139   1          for(j=0;j<MAXCHAR;j++)
 140   1          {
 141   2              aa[j]=0x00;
 142   2          }
 143   1          j=0;
 144   1      }
 145          
 146          /*****************************************************************************
 147          函数名称：Print_Char
 148          函数功能：发送单个字符
 149          入口参数: ch      
 150          出口参数：无
 151          *****************************************************************************/
 152          
 153          void Print_Char(uchar ch)
 154          {
 155   1          SBUF=ch; //送入缓冲区
 156   1          while(TI!=1); //等待发送完毕
 157   1          TI=0; //软件清零
 158   1      
 159   1      }
 160          
 161          /*****************************************************************************
 162          函数名称：Print_Str
 163          函数功能：发送字符串
 164          入口参数: *str    
 165          出口参数：无
 166          *****************************************************************************/
 167          
 168          void Print_Str(uchar *str)
 169          {
 170   1              while(*str!='\0')
 171   1          {
 172   2              Print_Char(*str);
 173   2              delay(2);
 174   2              str++;
 175   2      
 176   2          }
 177   1      }
 178          
 179          /*****************************************************************************
C51 COMPILER V9.00   MAIN                                                                  03/31/2013 17:28:43 PAGE 4   

 180          函数名称：led
 181          函数功能: 初始化的时候控制led亮灭看初始化是否成功
 182          入口参数: i
 183          出口参数: 无
 184          *****************************************************************************/
 185          
 186          void led(int i)
 187          {
 188   1          P2 |= i;
 189   1          delay(20);
 190   1          P2 &= ~i;
 191   1          delay(20);
 192   1          P2 |= i;
 193   1          delay(20);
 194   1          P2 &= ~i;
 195   1      }
 196          
 197          /*****************************************************************************
 198          函数名称：lcd_bz
 199          函数功能：检测lcd显示是否繁忙
 200          入口参数: 无    
 201          出口参数：result，忙为1，闲为0
 202          *****************************************************************************/
 203          
 204          bit lcd_bz(void)
 205          {
 206   1              bit result;
 207   1              rs = 0;
 208   1              rw = 1;
 209   1              ep = 1;
 210   1              _nop_();
 211   1              _nop_();
 212   1              _nop_();
 213   1              _nop_();
 214   1              result = (bit)(P0 & 0x80);
 215   1              ep = 0;
 216   1              return result;
 217   1      }
 218          
 219          /*****************************************************************************
 220          函数名称：lcd_wcmd
 221          函数功能：lcd写指令
 222          入口参数: cmd    
 223          出口参数：无
 224          *****************************************************************************/
 225          
 226          void lcd_wcmd(uchar cmd)
 227          {
 228   1              while(lcd_bz());//判断LCD是否忙碌
 229   1              rs = 0;
 230   1              rw = 0;
 231   1              ep = 0;
 232   1              _nop_();
 233   1              _nop_();
 234   1              P0 = cmd;
 235   1              _nop_();
 236   1              _nop_();
 237   1              _nop_();
 238   1              _nop_();
 239   1              ep = 1;
 240   1              _nop_();
 241   1              _nop_();
C51 COMPILER V9.00   MAIN                                                                  03/31/2013 17:28:43 PAGE 5   

 242   1              _nop_();
 243   1              _nop_();
 244   1              ep = 0;
 245   1      
 246   1      }
 247          
 248          /*****************************************************************************
 249          函数名称：lcd_wdat
 250          函数功能：lcd写数据
 251          入口参数: dat    
 252          出口参数：无
 253          *****************************************************************************/
 254          
 255          void lcd_wdat(uchar dat)
 256          {
 257   1              while(lcd_bz());//判断LCD是否忙碌
 258   1              rs = 1;
 259   1              rw = 0;
 260   1              ep = 0;
 261   1              P0 = dat;
 262   1              _nop_();
 263   1              _nop_();
 264   1              _nop_();
 265   1              _nop_();
 266   1              ep = 1;
 267   1              _nop_();
 268   1              _nop_();
 269   1              _nop_();
 270   1              _nop_();
 271   1              ep = 0;
 272   1      
 273   1      }
 274          
 275          /*****************************************************************************
 276          函数名称：lcd_disp_char
 277          函数功能：lcd显示一个字符
 278          入口参数: x，y，dat   
 279          出口参数：无
 280          *****************************************************************************/
 281          
 282          void lcd_disp_char(uchar x,uchar y,uchar dat)      // y为1时候是第一行，否则为第二行
 283          
 284          {
 285   1              uchar address ;
 286   1              if(y==1)
 287   1              {
 288   2                      address=0x80+x ;  //显示在第一排的时候x的地址
 289   2              }
 290   1              else
 291   1              {
 292   2                      address=0xc0+x ;   //显示在第二排的时候x的地址
 293   2              }
 294   1      
 295   1              lcd_wcmd(address);
 296   1              lcd_wdat(dat);
 297   1      
 298   1      }
 299          
 300          /*****************************************************************************
 301          函数名称：lcd_disp_str
 302          函数功能：lcd显示一个字符串
 303          入口参数: column，line，*str   
C51 COMPILER V9.00   MAIN                                                                  03/31/2013 17:28:43 PAGE 6   

 304          出口参数：无
 305          *****************************************************************************/
 306          
 307          void LCD_disp_str(uchar column,uchar line,uchar *str)
 308          {
 309   1              uchar n=0;
 310   1      
 311   1              while(*str!='\0')
 312   1              {
 313   2                      lcd_disp_char(column++,line,*str++);
 314   2              }
 315   1      
 316   1      }
 317          
 318          /*****************************************************************************
 319          函数名称：lcd_init
 320          函数功能：lcd初始化
 321          入口参数: 无    
 322          出口参数：无
 323          *****************************************************************************/
 324          
 325          void lcd_init(void)
 326          {
 327   1              lcd_wcmd(0x38);
 328   1              delay(1);
 329   1              lcd_wcmd(0x0c);
 330   1              delay(1);
 331   1              lcd_wcmd(0x06);
 332   1              delay(1);
 333   1              lcd_wcmd(0x01);
 334   1              delay(1);
 335   1      
 336   1      }
 337          
 338          /*****************************************************************************
 339          函数名称：AT
 340          函数功能：初始化TC35模块
 341          入口参数: 无    
 342          出口参数：无
 343          *****************************************************************************/
 344          
 345          void AT(void)
 346          {
 347   1              
 348   1              clearBuff();
 349   1          Print_Str(ATE0);
 350   1          delay(50);
 351   1      
 352   1              while(strstr(aa,"OK")==NULL)
 353   1          {
 354   2              delay(50);
 355   2              led(0x01);
 356   2              clearBuff();
 357   2              Print_Str(ATE0);
 358   2          }
 359   1              led(0x02);
 360   1      
 361   1              Print_Str(ATCN);
 362   1              delay(50);
 363   1      
 364   1              Print_Str(CMGF);
 365   1              delay(100);
C51 COMPILER V9.00   MAIN                                                                  03/31/2013 17:28:43 PAGE 7   

 366   1      
 367   1              while(1)
 368   1          {
 369   2              clearBuff();
 370   2              Print_Str(CREG_CMD);
 371   2              delay(50);
 372   2              if(((aa[9]=='0')&&(aa[11]=='1'))||((aa[9]=='0')&&(aa[11]=='5')))
 373   2              {
 374   3                  clearBuff();
 375   3                  led(0x08);
 376   3                  break;
 377   3              }
 378   2              else
 379   2              {
 380   3                  clearBuff();
 381   3                  led(0x04);
 382   3                  delay(50);
 383   3              }
 384   2              }
 385   1      }
 386          
 387          /*****************************************************************************
 388          函数名称：mq9_dat
 389          函数功能：mq9传入数据
 390          入口参数: 无    
 391          出口参数：dat
 392          *****************************************************************************/
 393          
 394          uchar get_mq9(void)
 395          {        
 396   1              uchar mq9;
 397   1      
 398   1              mq9=d0;
 399   1              delay(50);
 400   1              clearBuff();
 401   1      
 402   1              return mq9;
 403   1      
 404   1      }
 405          
 406          /*****************************************************************************
 407          函数名称：main
 408          函数功能：主函数
 409          入口参数: 无    
 410          出口参数：无
 411          *****************************************************************************/
 412          
 413          void main()
 414          {
 415   1              uchar mq9_dat,count=2;
 416   1              
 417   1              lcd_init();    //初始化LCD
 418   1              delay(10);
 419   1      
 420   1              lcd_disp_str(0,1,"Init UART..."); //初始化串口
 421   1              Ini_UART();    //初始化串口
 422   1              clearBuff();
 423   1              delay(1000);
 424   1      
 425   1              lcd_disp_str(0,1,"Init TC35..."); //初始化TC35
 426   1              AT();              //初始化模块
 427   1              delay(1000);
C51 COMPILER V9.00   MAIN                                                                  03/31/2013 17:28:43 PAGE 8   

 428   1      
 429   1              lcd_disp_str(0,1,"Init MQ-9..."); //初始化MQ-9 预热5秒
 430   1              delay(5000);
 431   1      
 432   1              while(count)
 433   1              {
 434   2                      lcd_disp_str(0,1,"Gas-Detect:");
 435   2      
 436   2                      if((mq9_dat=get_mq9)==1)
 437   2                      {                       
 438   3                              lcd_disp_str(0,2,"Normal   <100ppm");           
 439   3                      }
 440   2      
 441   2                      if((mq9_dat=get_mq9)==0)
 442   2                      {
 443   3                              delay(5000);
 444   3                      }
 445   2      
 446   2                      if((mq9_dat=get_mq9)==0)
 447   2                      {
 448   3                              lcd_disp_str(0,2,"Warning >=100ppm");
 449   3              
 450   3                              lcd_disp_str(0,1,"Send Message...");
 451   3                              Print_Str(SMS_send);  //发送中文短信
 452   3                              delay(500);
 453   3                              led(0x04);
 454   3      
 455   3                              Print_Str(Sms2_Pdu);  //发短信内容
 456   3                              delay(500);
 457   3                              led(0x08);
 458   3                      
 459   3                          Print_Char(0x1A);      //发送结束符号
 460   3                              delay(2000);
 461   3      
 462   3                              lcd_disp_str(0,1,"Make Calling...");
 463   3                              Print_Str("ATD15940236025;\r\n"); //打电话
 464   3                              delay(3000);
 465   3      
 466   3                              count--;
 467   3                      }
 468   2              }
 469   1      
 470   1              lcd_disp_str(0,1,"Detect Waring!!!");
 471   1      
 472   1      }
 473          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    762    ----
   CONSTANT SIZE    =    291    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     81       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
