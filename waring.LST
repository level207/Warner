C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE WARING
OBJECT MODULE PLACED IN waring.OBJ
COMPILER INVOKED BY: D:\Program Files\Keil C\C51\BIN\C51.EXE waring.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /**************************头文件、宏定义、函数声明*************************/
   2          
   3          #include <reg52.h>
   4          #include <intrins.h>
   5          #include <stdio.h>
   6          #include <string.h>
   7          
   8          #define uint unsigned int
   9          #define uchar unsigned char
  10          #define MAXCHAR 81
  11          
  12          void delay(uchar ms);
  13          void Ini_UART(void);
  14          void ser();
  15          void clearBuff(void);
  16          void Print_Char(uchar ch);
  17          void Print_Str(uchar *str);
  18          void led(int i);
  19          
  20          void AT(void);
  21          bit lcd_bz(void);
  22          void lcd_wcmd(uchar cmd);
  23          void lcd_disp_char(uchar x,uchar y,uchar dat);
  24          void lcd_disp_str(uchar column,uchar line,uchar *str);
  25          void lcd_wdat(uchar dat);
  26          void lcd_init(void);
  27          int get_mq9(void);
  28          
  29          /*********************************定义数组**********************************/
  30          
  31          uchar  aa[MAXCHAR];
  32          uchar j=0;
  33          code uchar ATE0[]="ATE0\r\n";                      //程序初始化AT部分首先关闭回显
  34          code uchar CREG_CMD[]="AT+CREG?\r\n";      //查询网络注册情况
  35          code uchar SMS_send[]="AT+CMGS=23\r\n";    //八位位组代码数目
  36          code uchar ATCN[]="AT+CNMI=2,1\r\n";       //短信存入SIM卡
  37          code uchar CMGF[]="AT+CMGF=0\r\n";                 //消息格式为PDU,中文短信
  38          code uchar CMGR[12]="AT+CMGR=1\r\n";       //读取第一条消息
  39          code uchar CMGD[12]="AT+CMGD=1\r\n";       //删除第一条消息
  40          code uchar CMGS[]="AT+CMGS=\"18604042139\"\r\n";
  41          /*****************************************************************************
  42          1.如果你的晶振是11.0592M
  43          只需要修改下面的号码就可以了,给成你手上拿着的手机的号码
  44          
  45          
  46          修改方法   在下面这段字符中找到 5129021411F5 
  47           
  48           其实5129021411F5 --> 15922041115
  49          18622044083 8126924480F3
  50                                                                                                                             8106042431F9
  51          
  52           看明白了吗  电话是两位两位颠倒 将您手上的手机号码替换即可
  53          *****************************************************************************/
  54          uchar  code Sms2_Pdu[]="0891683108200405F011000D91688106894237F40008000862116210529F4E86";
  55          
C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 2   

  56          /*********************************端口定义**********************************/
  57          
  58          sbit bee= P1^1;
  59          sbit d0 = P2^4;//mq9输入端口
  60          sbit rs = P2^5;
  61          sbit rw = P2^6;
  62          sbit ep = P2^7;
  63          sbit bee_off=P3^2;
  64          
  65          /*****************************************************************************
  66          函数名称：delay
  67          函数功能: LCD延时子程序
  68          入口参数: ms
  69          出口参数: 无
  70          *****************************************************************************/
  71          
  72          void delay(uchar ms)
  73          {
  74   1              uchar i;
  75   1      
  76   1              while(ms--)
  77   1              {
  78   2                      for(i = 0; i< 250; i++)
  79   2                      {
  80   3                              _nop_();
  81   3                              _nop_();
  82   3                              _nop_();
  83   3                              _nop_();
  84   3      
  85   3                      }
  86   2              }
  87   1      }
  88          
  89          /*****************************************************************************
  90          函数名称：Ini_UART
  91          函数功能：串口初始化、定时器初始化
  92          入口参数: 无     
  93          出口参数：无
  94          *****************************************************************************/
  95          
  96          void Ini_UART(void)//串口初始化、定时器初始化
  97          {
  98   1          SCON = 0x50 ;  //SCON: serail mode 1, 8-bit UART, enable ucvr
  99   1          //UART为模式1，8位数据，允许接收
 100   1          TMOD |= 0x20 ; //TMOD: timer 1, mode 2, 8-bit reload
 101   1          //定时器1为模式2,8位自动重装
 102   1          PCON |= 0x80 ; //SMOD=1;
 103   1          TH1 = 0xFA ;   //Baud:19200 fosc="11".0592MHz
 104   1          TL1=0xFA;
 105   1          IE |= 0x90 ;     //Enable Serial Interrupt
 106   1          TR1 = 1 ;       // timer 1 run
 107   1          TI=1;
 108   1          ES=1;
 109   1      }
 110          
 111          /*****************************************************************************
 112          函数名称：ser() interrupt 4
 113          函数功能：串口中断函数，串口有数据传输时进入此中断
 114          入口参数: 无     
 115          出口参数：无
 116          *****************************************************************************/
 117          
C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 3   

 118          void ser() interrupt 4
 119          {
 120   1      
 121   1          if(RI==1)
 122   1          {  
 123   2                      aa[j]=SBUF;//命令存到命令数组
 124   2                      RI=0; //软件清除接收中断
 125   2              j++;
 126   2      
 127   2          }
 128   1      }
 129          
 130          /*****************************************************************************
 131          函数名称：clearBuff
 132          函数功能: 清楚串口缓冲区数据
 133          入口参数: 无
 134          出口参数: 无
 135          *****************************************************************************/
 136          
 137          void clearBuff(void)
 138          {
 139   1      
 140   1          for(j=0;j<MAXCHAR;j++)
 141   1          {
 142   2              aa[j]=0x00;
 143   2          }
 144   1          j=0;
 145   1      }
 146          
 147          /*****************************************************************************
 148          函数名称：Print_Char
 149          函数功能：发送单个字符
 150          入口参数: ch      
 151          出口参数：无
 152          *****************************************************************************/
 153          
 154          void Print_Char(uchar ch)
 155          {
 156   1          SBUF=ch; //送入缓冲区
 157   1          while(TI!=1); //等待发送完毕
 158   1          TI=0; //软件清零
 159   1      
 160   1      }
 161          
 162          /*****************************************************************************
 163          函数名称：Print_Str
 164          函数功能：发送字符串
 165          入口参数: *str    
 166          出口参数：无
 167          *****************************************************************************/
 168          
 169          void Print_Str(uchar *str)
 170          {
 171   1              while(*str!='\0')
 172   1          {
 173   2              Print_Char(*str);
 174   2              delay(2);
 175   2              str++;
 176   2      
 177   2          }
 178   1      }
 179          
C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 4   

 180          /*****************************************************************************
 181          函数名称：led
 182          函数功能: 初始化的时候控制led亮灭看初始化是否成功
 183          入口参数: i
 184          出口参数: 无
 185          *****************************************************************************/
 186          
 187          void led(int i)
 188          {
 189   1          P2 |= i;
 190   1          delay(20);
 191   1          P2 &= ~i;
 192   1          delay(20);
 193   1          P2 |= i;
 194   1          delay(20);
 195   1          P2 &= ~i;
 196   1      }
 197          
 198          /*****************************************************************************
 199          函数名称：lcd_bz
 200          函数功能：检测lcd显示是否繁忙
 201          入口参数: 无    
 202          出口参数：result，忙为1，闲为0
 203          *****************************************************************************/
 204          
 205          bit lcd_bz(void)
 206          {
 207   1              bit result;
 208   1              rs = 0;
 209   1              rw = 1;
 210   1              ep = 1;
 211   1              _nop_();
 212   1              _nop_();
 213   1              _nop_();
 214   1              _nop_();
 215   1              result = (bit)(P0 & 0x80);
 216   1              ep = 0;
 217   1              return result;
 218   1      }
 219          
 220          /*****************************************************************************
 221          函数名称：lcd_wcmd
 222          函数功能：lcd写指令
 223          入口参数: cmd    
 224          出口参数：无
 225          *****************************************************************************/
 226          
 227          void lcd_wcmd(uchar cmd)
 228          {
 229   1              while(lcd_bz());//判断LCD是否忙碌
 230   1              rs = 0;
 231   1              rw = 0;
 232   1              ep = 0;
 233   1              _nop_();
 234   1              _nop_();
 235   1              P0 = cmd;
 236   1              _nop_();
 237   1              _nop_();
 238   1              _nop_();
 239   1              _nop_();
 240   1              ep = 1;
 241   1              _nop_();
C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 5   

 242   1              _nop_();
 243   1              _nop_();
 244   1              _nop_();
 245   1              ep = 0;
 246   1      
 247   1      }
 248          
 249          /*****************************************************************************
 250          函数名称：lcd_wdat
 251          函数功能：lcd写数据
 252          入口参数: dat    
 253          出口参数：无
 254          *****************************************************************************/
 255          
 256          void lcd_wdat(uchar dat)
 257          {
 258   1              while(lcd_bz());//判断LCD是否忙碌
 259   1              rs = 1;
 260   1              rw = 0;
 261   1              ep = 0;
 262   1              P0 = dat;
 263   1              _nop_();
 264   1              _nop_();
 265   1              _nop_();
 266   1              _nop_();
 267   1              ep = 1;
 268   1              _nop_();
 269   1              _nop_();
 270   1              _nop_();
 271   1              _nop_();
 272   1              ep = 0;
 273   1      
 274   1      }
 275          
 276          /*****************************************************************************
 277          函数名称：lcd_disp_char
 278          函数功能：lcd显示一个字符
 279          入口参数: x，y，dat   
 280          出口参数：无
 281          *****************************************************************************/
 282          
 283          void lcd_disp_char(uchar x,uchar y,uchar dat)      // y为1时候是第一行，否则为第二行
 284          
 285          {
 286   1              uchar address ;
 287   1              if(y==1)
 288   1              {
 289   2                      address=0x80+x ;  //显示在第一排的时候x的地址
 290   2              }
 291   1              else
 292   1              {
 293   2                      address=0xc0+x ;   //显示在第二排的时候x的地址
 294   2              }
 295   1      
 296   1              lcd_wcmd(address);
 297   1              lcd_wdat(dat);
 298   1      
 299   1      }
 300          
 301          /*****************************************************************************
 302          函数名称：lcd_disp_str
 303          函数功能：lcd显示一个字符串
C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 6   

 304          入口参数: column，line，*str   
 305          出口参数：无
 306          *****************************************************************************/
 307          
 308          void lcd_disp_str(uchar column,uchar line,uchar *str)
 309          {
 310   1              uchar n=0;
 311   1      
 312   1              while(*str!='\0')
 313   1              {
 314   2                      lcd_disp_char(column++,line,*str++);
 315   2              }
 316   1      
 317   1      }
 318          
 319          /*****************************************************************************
 320          函数名称：lcd_init
 321          函数功能：lcd初始化
 322          入口参数: 无    
 323          出口参数：无
 324          *****************************************************************************/
 325          
 326          void lcd_init(void)
 327          {
 328   1              lcd_wcmd(0x38);
 329   1              delay(1);
 330   1              lcd_wcmd(0x0c);
 331   1              delay(1);
 332   1              lcd_wcmd(0x06);
 333   1              delay(1);
 334   1              lcd_wcmd(0x01);
 335   1              delay(1);
 336   1      
 337   1      }
 338          
 339          /*****************************************************************************
 340          函数名称：AT
 341          函数功能：初始化TC35模块
 342          入口参数: 无    
 343          出口参数：无
 344          *****************************************************************************/
 345          
 346          void AT(void)
 347          {
 348   1              
 349   1              clearBuff();
 350   1          Print_Str(ATE0);//程序初始化AT部分首先关闭回显
 351   1          delay(50);
 352   1      
 353   1              while(strstr(aa,"OK")==NULL)
 354   1          {
 355   2              delay(50);
 356   2              led(0x01);
 357   2              clearBuff();
 358   2              Print_Str(ATE0);
 359   2          }
 360   1              led(0x02);
 361   1      
 362   1              Print_Str(ATCN);//短信存入SIM卡
 363   1              delay(50);
 364   1      
 365   1              Print_Str(CMGF);//消息格式为PDU,中文短信
C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 7   

 366   1              delay(100);
 367   1      
 368   1              while(1)
 369   1          {
 370   2              clearBuff();
 371   2              Print_Str(CREG_CMD);//查询网络注册情况
 372   2              delay(50);
 373   2              if(((aa[9]=='0')&&(aa[11]=='1'))||((aa[9]=='0')&&(aa[11]=='5')))
 374   2              {
 375   3                  clearBuff();
 376   3                  led(0x08);
 377   3                  break;
 378   3              }
 379   2              else
 380   2              {
 381   3                  clearBuff();
 382   3                  led(0x04);
 383   3                  delay(50);
 384   3              }
 385   2              }
 386   1      }
 387          
 388          /*****************************************************************************
 389          函数名称：mq9_dat
 390          函数功能：mq9传入数据
 391          入口参数: 无    
 392          出口参数：dat
 393          *****************************************************************************/
 394          
 395          int get_mq9(void)
 396          {        
 397   1              int mq9;
 398   1      
 399   1              mq9=(d0&1);
 400   1              delay(25);
 401   1              clearBuff();
 402   1      
 403   1              return  mq9;
 404   1      }
 405          
 406          /*****************************************************************************
 407          函数名称：main
 408          函数功能：主函数
 409          入口参数: 无    
 410          出口参数：无
 411          *****************************************************************************/
 412          
 413          void main()
 414          {
 415   1              int mq9_dat=0,count=1;
 416   1      
 417   1              lcd_init();    //初始化LCD
 418   1      
 419   1              lcd_disp_str(0,1,"Init UART..."); //初始化串口
 420   1              Ini_UART();    //初始化串口
 421   1              clearBuff();
 422   1              delay(100);
 423   1      
 424   1              
 425   1              lcd_wcmd(0x01);
 426   1              lcd_disp_str(0,1,"Init TC35..."); //初始化TC35
 427   1              AT();              //初始化TC35
C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 8   

 428   1      
 429   1              lcd_disp_str(0,1,"Init MQ-9..."); //初始化MQ-9 预热5秒
 430   1              delay(250);
 431   1      
 432   1              while(count)
 433   1              {       
 434   2                      if((mq9_dat=get_mq9())==1)
 435   2                      {       
 436   3                              count=1;
 437   3                              bee=1;
 438   3                              lcd_wcmd(0x01);
 439   3                              lcd_disp_str(0,1,"Gas-Detect:");                
 440   3                              lcd_disp_str(0,2,"Normal   <100ppm");
 441   3                              delay(250);     
 442   3                      }
 443   2      
 444   2                      if((mq9_dat=get_mq9())==0)
 445   2                      {
 446   3                              lcd_wcmd(0x01);
 447   3                              lcd_disp_str(0,1,"Gas-Detect:");
 448   3                              lcd_disp_str(0,2,"Warning >=100ppm");
 449   3                              delay(250);
 450   3                      }
 451   2      
 452   2                      if((mq9_dat=get_mq9())==0)
 453   2                      {
 454   3                              lcd_wcmd(0x01);
 455   3                              lcd_disp_str(0,1,"Gas-Detect:");
 456   3                              lcd_disp_str(0,2,"Warning >=100ppm");
 457   3                              bee=0;
 458   3      
 459   3      
 460   3                              lcd_disp_str(0,1,"Make Calling...");//打电话
 461   3                              lcd_disp_str(0,2,"Warning >=100ppm");
 462   3                              delay(10);
 463   3                              Print_Str("ATD13898106410;\r\n"); 
 464   3                              delay(250);
 465   3                              delay(250);
 466   3                              Print_Str("ATA\r\n");
 467   3                              delay(20);
 468   3      
 469   3                              lcd_wcmd(0x01);
 470   3                              lcd_disp_str(0,1,"Send Message...");
 471   3                              lcd_disp_str(0,2,"Warning >=100ppm");
 472   3      
 473   3                              Print_Str("AT+CMGF=1\r\n");//发送短信
 474   3                              delay(20);
 475   3                              led(0x04);
 476   3                              Print_Str("AT+CMGS=\"13898106410\"\r\n");
 477   3                              delay(10);
 478   3                              Print_Str("Warning! Gas leakage!!!");
 479   3                              Print_Char(0x1A);
 480   3                              Print_Str("\r\n");
 481   3                              delay(250);
 482   3                              delay(250);
 483   3      
 484   3                              count--;                        
 485   3              
 486   3                      }
 487   2              }
 488   1      
 489   1              while(1)
C51 COMPILER V9.00   WARING                                                                05/05/2013 11:22:09 PAGE 9   

 490   1              {
 491   2                      if(bee_off==0)  bee=1;//有按键按下就关闭蜂鸣器
 492   2                      lcd_wcmd(0x01);
 493   2                      lcd_disp_str(0,1,"Detect Warning!!");
 494   2                      lcd_disp_str(0,2," Gas Leakage!!!");
 495   2                      delay(250);
 496   2              }
 497   1      }
 498          
 499          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    906    ----
   CONSTANT SIZE    =    410    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     82      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
